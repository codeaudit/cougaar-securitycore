####################################################
# enclave_safeguard_component.rule

enclave = nil

compFactory = "org.cougaar.core.security.provider.SecurityComponentFactory"

society.each_node do |node|
  if node.name =~ /.*REAR.*/ \
	or node.name == "REAR-CA-NODE" \
	or node.name == "REAR-MGMT-NODE"
    enclave = "Rear"
    community = "REAR-SECURITY-COMM"
  elsif node.name =~ /.*FWD.*/ \
	or node.name == "FWD-CA-NODE" \
	or node.name == "FWD-MGMT-NODE"
    enclave = "Fwd"
    community = "FWD-SECURITY-COMM"
  elsif node.name == "NCA-NODE" \
	or node.name == "CONUS-NODE" \
	or node.name == "ROOT-CA-NODE" \
	or node.name == "CONUS-CA-NODE" \
	or node.name == "CONUS-MGMT-NODE"
    enclave = "Conus"
    community = "CONUS-SECURITY-COMM"
  elsif node.name =~ /.*TRANS.*/ \
	or node.name == "AIR-NODE" \
	or node.name == "SEA-NODE" \
	or node.name == "TRANS-CA-NODE" \
	or node.name == "TRANS-MGMT-NODE"
    enclave = "Trans"
    community = "TRANS-SECURITY-COMM"
  end

  # Add the KAoS guard
  node.agent.add_component do |c|
    c.name = "safe.util.SAFESecurityComponentEnclave" + enclave
    c.classname = "safe.util.SAFESecurityComponent"
    c.priority = "HIGH"
    c.insertionpoint = "Node.AgentManager.Agent.SecurityComponent"
    c.add_argument(enclave + "PolicyDomainManager")
    c.add_argument(enclave + "Domain")
  end

  # Add the security component factory
  node.agent.add_component do |c|
    c.classname = compFactory
    c.priority = "HIGH"
    c.insertionpoint = "Node.AgentManager.Agent.SecurityComponent"
    c.add_argument(community)
  end
end
