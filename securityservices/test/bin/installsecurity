#!/bin/sh

# This file compiles and packages the security services in a safe way.
# It does not overwrite files from $COUGAAR_INSTALL_PATH
# Instead, it creates a security.tar file that contains all the files necessary
# to run the security services.

# This file should be run from the top directory in the securityservices module.

realCIP=$COUGAAR_INSTALL_PATH
startupdir=`pwd`
tmpdir=`mktemp -d /tmp/cip.XXXXXX`
if [ "$?" != 0 ]; then
    echo "$0: Can't create temp file, exiting..."
    exit 1
fi
install=0
if [ "$#" != "0" ]; then
  if [ "$1" == "-i" ]; then
    install=1;
  else
    echo "Usage: $0 [-i]"
    exit 1
  fi
fi

COUGAAR_INSTALL_PATH=${tmpdir}
export COUGAAR_INSTALL_PATH

# Copy jar files from the real $CIP
mkdir $COUGAAR_INSTALL_PATH/lib
mkdir $COUGAAR_INSTALL_PATH/sys
cp ${realCIP}/lib/*.jar $COUGAAR_INSTALL_PATH/lib
cp ${realCIP}/sys/*.jar $COUGAAR_INSTALL_PATH/sys
mkdir -p $COUGAAR_INSTALL_PATH/csmart/config/rules/security
cp test/configs/recipes/rules/*.rule $COUGAAR_INSTALL_PATH/csmart/config/rules/security
cp test/configs/recipes/rules/parameters/security_param_tic.rule $COUGAAR_INSTALL_PATH/csmart/config/rules/security

#PATH=/mnt/shared/srosset/apache-ant-1.5.3-1/bin/:$PATH
#export PATH
COUGAAR_WORKSPACE=$COUGAAR_INSTALL_PATH/workspace && export COUGAAR_WORKSPACE

which ant >& /dev/null
if [ $? != 0 ]; then
  if [ -d "/mnt/shared/srosset/apache-ant-1.5.3-1/bin" ]; then
    ant=/mnt/shared/srosset/apache-ant-1.5.3-1/bin/ant
  else
    echo "$0: Can't find ant. Add it to your path. Exiting..."
    rm -rf ${tmpdir}
    exit 1
  fi
else
  ant=`which ant`
fi

$ant install

echo "Zipping files to AS_csi_secserv.zip"
cd $COUGAAR_INSTALL_PATH
zip -qr AS_csi_secserv.zip \
	log/bootstrap \
	configs/daml \
	configs/security \
	csmart/config/rules/security \
	lib/CougaarCRLextensions.jar \
	lib/idmef.jar \
	lib/kaos.jar \
	lib/safe.jar \
	lib/securebootstrapper.jar \
	lib/securityservices.jar \
	webtomcat/data/conf/server.xml \
	webtomcat/data/webapps/ROOT/WEB-INF/web.xml \
	sys/antlr.jar \
	sys/ontologyRepInit.jar \
	sys/bcprov-jdk14*.jar \
	sys/ibmpkcs.jar \
	sys/jas.jar \
	sys/jpcsc.jar \
	sys/polCert.jar \
	sys/jasper-runtime.jar \
	sys/jtp.jar \
	sys/Tidy.jar \
	sys/dl.jar \
	sys/iw.jar \
	sys/jdom.jar

cp AS_csi_secserv.zip ${startupdir}
rm -rf ${tmpdir}

#echo 
#echo 
#echo 'This script has generated a file named "security.tar" in the current directory'
#echo 'Untar the file security.tar under $COUGAAR_INSTALL_PATH'
#echo
#echo -n 'Do you want to untar the file to $COUGAAR_INSTALL_PATH (y/n)? '
#read reply

#if [ ${reply} == "y" ]; then
if [ "$install" == "1" ]; then
	echo "Extracting security.tar to ${realCIP}"
	cd ${realCIP}
	unzip -qo ${startupdir}/AS_csi_secserv.zip
fi
