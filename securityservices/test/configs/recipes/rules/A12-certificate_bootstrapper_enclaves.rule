####################################################
# certificate_bootstrapper_enclaves.rule

fwdCaHost = nil
rearCaHost = nil
conusCaHost = nil
transCaHost = nil
society.each_node do |node|
  if node.name == 'REAR-CA-NODE'
    rearCaHost = node.host.name 
  elsif node.name == 'FWD-CA-NODE'
    fwdCaHost = node.host.name 
  elsif node.name == 'CONUS-CA-NODE'
    conusCaHost = node.host.name 
  elsif node.name == 'TRANS-CA-NODE'
    transCaHost = node.host.name 
  end
end

caHttpPort = "8810"
caHttpsPort = "9810"

society.each_node do |node|
  # Some of the  ** and node.name != ** tests are not necessary
  # but it's helpful to remember that the component should not
  # go in the CA node.
  arg = nil
  if (node.name =~ /.*REAR.*/) \
	and node.name != 'REAR-CA-NODE'
    # node agents in REAR enclave
    arg = rearCaHost + ":RearEnclaveCaManager"

  elsif (node.name =~ /.*FWD.*/) \
	and node.name != 'FWD-CA-NODE'
    # node agents in FWD enclave
    arg = fwdCaHost + ":FwdEnclaveCaManager"

  elsif (node.name == "NCA-NODE" \
	 or node.name == "CONUS-NODE" \
	 or node.name == "CONUS-MGMT-NODE") \
	and node.name != 'CONUS-CA-NODE'
    # node agents in CONUS enclave
    arg = conusCaHost + ":ConusEnclaveCaManager"

  elsif (node.name =~ /.*TRANS.*/ \
	 or node.name == "AIR-NODE" \
	 or node.name == "SEA-NODE") \
	and node.name != 'TRANS-CA-NODE'
    # node agents in TRANS enclave
    arg = transCaHost + ":TransEnclaveCaManager"
  end

  if arg != nil
    arg = arg + ":" + caHttpPort + ":" + caHttpsPort
    node.agent.add_component do |c|
      c.classname = "org.cougaar.core.security.crypto.AutoConfigPlugin"
      c.priority = "HIGH"
      c.insertionpoint = "Node.AgentManager.Agent.SecurityComponent"
      c.add_argument(arg)
    end
  end
end
